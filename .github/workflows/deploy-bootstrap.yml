name: Deploy Bootstrap
run-name: Deployment to ${{ inputs.deploy_target }} by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: Environment to deploy
        options:
        - dev
        - test
        - prod
        default: dev

jobs:
  bicep:
    name: 'Bicep Deploy Bootstrap into ${{ github.event.inputs.environment }} environment'
    runs-on: ubuntu-latest
    env:
      BUILD_NUMBER: ${{ github.run_id }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Azure Context
      uses: azure/cli@v2
      with:
        azcliversion: latest
        inlineScript: |
          az account show
    
    - name: Bicep Installation
      uses: azure/cli@v2
      with:
        azcliversion: latest
        inlineScript: |
          export DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1
          az bicep install
          az bicep version

    - name: Bicep Validate
      uses: Azure/cli@v1
      with:
        azcliversion: latest
        inlineScript: |
          cd bootstrap
          az deployment sub validate \
            --name validate-${{ github.run_id }} \
            --template-file bootstrap_${{ github.event.inputs.environment }}.bicep \
            --location westeurope \
            --what-if
    
    - name: Bicep Plan
      uses: Azure/cli@v1
      with:
        azcliversion: latest
        inlineScript: |
          cd bootstrap
          az deployment sub create \
            --name validate-${{ github.run_id }} \
            --template-file bootstrap_${{ github.event.inputs.environment }}.bicep \
            --location westeurope \
            --what-if
    
    - name: Approval
      uses: actions/github-script@v6
      with:
        script: |
          github.repos.createDeployment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.sha,
            environment: 'approval'
          }) 

    - name: Bicep Deploy
      uses: Azure/cli@v1
      with:
        azcliversion: latest
        inlineScript: |
          cd bootstrap
          az deployment sub create \
            --name validate-${{ github.run_id }} \
            --template-file bootstrap_${{ github.event.inputs.environment }}.bicep \
            --location westeurope \
            --what-if