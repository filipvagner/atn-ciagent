name: Deploy Bootstrap
on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: Environment to deploy
        options:
        - dev
        - test
        - prod
        default: dev

jobs:
  bicep:
    name: 'Bicep Deploy Bootstrap into ${{ github.event.inputs.environment }}'
    runs-on: ubuntu-latest
    env:
      BUILD_NUMBER: ${{ github.run_id }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Azure Subscription
      uses: azure/cli@v2
      with:
        azcliversion: latest
        inlineScript: |
          az account show
    
    - name: Bicep Deloyment
      uses: azure/cli@v2
      with:
        azcliversion: latest
        inlineScript: |
          export DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1
          az bicep install
          az bicep version

    - name: Bicep Validate
      uses: Azure/cli@v1
      with:
        azcliversion: latest
        inlineScript: |
          cd bootstrap
          az deployment sub validate \
            --name validate-${{ github.run_id }} \
            --template-file bootstrap_${{ github.event.inputs.environment }}.bicep \
            --location "westeurope"